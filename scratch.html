<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scratch & Win!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* Green Tinted Background */
            background: linear-gradient(135deg, #bbdb72 0%, #78ffd6 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: #f5f5dc;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
        }

        /* --- HEADER: Light Green --- */
        .header {
            background: linear-gradient(135deg, #5cc780 0%, #96f1e1 100%);
            padding: 20px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .company-logo {
            width: 180px;
            height: auto;
            margin-bottom: 10px;
            display: block; 
            margin-left: auto;
            margin-right: auto;
        }

        .header h1 {
            font-size: clamp(22px, 5vw, 32px);
            margin-bottom: 5px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: clamp(14px, 3vw, 16px);
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Form Styles */
        .form-container {
            width: 100%;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input[type="tel"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            background: #f8f9fa;
            font-weight: 600;
            letter-spacing: 1px;
        }

        /* --- SINGLE ROW RADIO BUTTONS --- */
        .radio-group {
            display: flex;
            flex-direction: row;
            gap: 10px;
            justify-content: space-between;
            width: 100%;
        }

        .radio-option {
            flex: 1;
            position: relative;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .radio-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
            color: #555;
            font-weight: 700;
            line-height: 1.2;
        }

        .radio-option input[type="radio"]:checked + label {
            background: #e8f5e9;
            border-color: #43e97b;
            color: #2e7d32;
            box-shadow: 0 4px 10px rgba(67, 233, 123, 0.2);
            transform: translateY(-2px);
        }
        /* ------------------------------- */

        .error-message {
            color: #f5576c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        .error-message.show { display: block; }

        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg,#5cc780 0%, #015143 100%);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(67, 233, 123, 0.4);
            margin-top: 10px;
        }

        /* Scratch Card Section */
        .scratch-container {
            display: none;
            width: 100%;
            animation: fadeIn 0.5s ease-in;
            flex-direction: column;
            align-items: center;
        }

        .instruction {
            text-align: center;
            margin-bottom: 20px;
        }
        .instruction h2 { color: #43e97b; font-size: 24px; margin-bottom: 5px; }
        .instruction p { color: #666; font-size: 14px; }

        /* --- SINGLE SCRATCH CARD --- */
        .scratch-card-wrapper {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
            cursor: pointer;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            overflow: hidden;
            /* Important: Ensures canvas stays visible initially */
            background: #ccc; 
        }

        .scratch-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            z-index: 1; /* Behind canvas */
        }

        .prize-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin-bottom: 15px;
        }

        .prize-emoji { font-size: 100px; margin-bottom: 10px; }
        
        .prize-text {
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            color: #333;
            padding: 0 20px;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2; /* On top */
            touch-action: none;
        }

        .scratch-icon {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            pointer-events: none;
            z-index: 3;
            animation: handMove 1.5s infinite;
        }

        @keyframes handMove {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            50% { transform: translate(-30%, -50%) rotate(20deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }

        /* Result Modal */
        .result-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center; align-items: center;
            padding: 20px;
        }

        .result-content {
            background: white;
            border-radius: 30px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
            text-align: center;
            animation: popIn 0.5s ease;
        }

        @keyframes popIn { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }

        .result-img-modal { max-width: 180px; height: auto; margin-bottom: 20px; }
        .result-title { font-size: 28px; color: #333; margin-bottom: 10px; font-weight: bold; }
        .result-prize { font-size: 22px; color: #43e97b; margin-bottom: 30px; font-weight: 600; }

        .close-btn {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white; border: none; padding: 15px 40px;
            font-size: 18px; font-weight: bold; border-radius: 25px;
            cursor: pointer; box-shadow: 0 5px 20px rgba(67, 233, 123, 0.4);
        }

        .loading { display: none; text-align: center; padding: 20px; }
        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #43e97b;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .confetti {
            position: fixed; width: 10px; height: 10px; background: #f093fb;
            position: absolute; animation: confetti-fall 3s linear forwards;
        }
        @keyframes confetti-fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }

    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <a href="index.html" style="position: absolute; top: 20px; left: 20px; text-decoration: none; font-size: 24px; z-index: 10;">üè†</a>
            <img src="images/company-logo.png" alt="Company Logo" class="company-logo">
            <h1>üé´ Scratch & Win!</h1>
            <p>Reveal your lucky prize</p>
        </div>

        <div class="content">
            <div class="form-container" id="formContainer">
                <form id="participantForm">
                    <div class="form-group">
                        <label for="phone">üì± Enter Your Mobile Number*</label>
                        <input type="tel" id="phone" name="phone" placeholder="Enter 10-digit number" inputmode="numeric" maxlength="10" required>
                        <div class="error-message" id="phoneError">Please enter a valid 10-digit phone number</div>
                    </div>

                    <div class="form-group">
                        <label>üë§ I am a *</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="cat_consumer" name="category" value="consumer" required>
                                <label for="cat_consumer">Consumer</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="cat_agent" name="category" value="agent">
                                <label for="cat_agent">Agent / Distributor</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="cat_rest" name="category" value="restaurant">
                                <label for="cat_rest">Restaurant Owner</label>
                            </div>
                        </div>
                        <div class="error-message" id="categoryError">Please select a category</div>
                    </div>

                    <button type="submit" class="submit-btn">üé´ Get Scratch Card!</button>
                </form>
            </div>

            <div class="scratch-container" id="scratchContainer">
                <div class="instruction">
                    <h2>Good Luck! üçÄ</h2>
                    <p>Let's try your luck!</p>
                </div>

                <div class="scratch-card-wrapper" id="scratchCardWrapper">
                    <div class="scratch-card-back" id="cardBack">
                        </div>
                    <canvas id="scratchCanvas"></canvas>
                    <div class="scratch-icon">üëÜ</div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p style="margin-top: 15px; color: #43e97b; font-weight: 600;">Generating your card...</p>
            </div>
        </div>
    </div>

    <div class="result-modal" id="resultModal">
        <div class="result-content">
            <img id="resultImage" class="result-img-modal" style="display: none;" alt="Prize">
            <div class="result-emoji" id="resultEmoji">üéÅ</div>
            <h2 class="result-title" id="resultTitle">Congratulations!</h2>
            <p class="result-prize" id="resultPrize">You won something amazing!</p>
            <button class="close-btn" id="closeBtn">Claim Prize!</button>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbywkY3hXRnNfvnpBOp7n-QTjOeF0PDahdiRilyF6OS7Es4yjuwBe6U3nKiZrLLm16D9/exec';
        
        // --- PRIZES (100% Total) ---
        const prizes = [
            { name: '500g Sambar', percentage: 10, isProduct: true, image: 'images/500g-Sambar.png' },
            { name: '200g Kulambu Chilli Masala', percentage: 10, isProduct: true, image: 'images/200g-kulambu-chilli.png' },
            { name: '50g Chilli Powder', percentage: 10, isProduct: true, image: 'images/50g-chilli.png' },
            { name: '50g Idly Chutney', percentage: 10, isProduct: true, image: 'images/50g-idly-chutney.png' },
            { name: '50g Sambar Powder', percentage: 10, isProduct: true, image: 'images/50g-sambar.png' },
            { name: 'Rs.10 Junior Pack', percentage: 10, isProduct: true, image: 'images/company-logo.png' },
            { name: 'Rs.10 Junior Pack', percentage: 20, isProduct: true, image: 'images/company-logo.png' },
            { name: 'Rs.10 Junior Pack', percentage: 10, isProduct: true, image: 'images/company-logo.png' },
            { name: 'Rs.10 Junior Pack', percentage: 5, isProduct: true, image: 'images/company-logo.png' },
            { name: 'Rs.10 Junior Pack', percentage: 5, isProduct: true, image: 'images/company-logo.png' }
        ];

        const STORAGE_KEY = 'scratchCardParticipants';
        
        function getParticipants() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : {};
        }

        function hasParticipated(phoneNumber) {
            const participants = getParticipants();
            return participants.hasOwnProperty(phoneNumber);
        }

        function addParticipant(phoneNumber, category) {
            const participants = getParticipants();
            participants[phoneNumber] = { category: category, timestamp: new Date().toISOString() };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(participants));
        }

       // REPLACE THE OLD sendToGoogleSheets FUNCTION IN scratch.html WITH THIS:
        async function sendToGoogleSheets(phoneNumber, category, prize) {
            try {
                const timestamp = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
                
                // --- UPDATED DATA OBJECT WITH GAME NAME ---
                const data = { 
                    phoneNumber: phoneNumber, 
                    category: category, 
                    prize: prize, 
                    timestamp: timestamp,
                    game: 'Scratch Card' // <--- This identifies the game
                };
                // ------------------------------------------

                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return true;
            } catch (error) { return false; }
        }

        const form = document.getElementById('participantForm');
        const phoneInput = document.getElementById('phone');
        const phoneError = document.getElementById('phoneError');
        const categoryError = document.getElementById('categoryError');
        const categoryInputs = document.querySelectorAll('input[name="category"]');

        categoryInputs.forEach(input => {
            input.addEventListener('change', () => categoryError.classList.remove('show'));
        });

        phoneInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 10) this.value = this.value.slice(0, 10);
            phoneError.classList.remove('show');
        });

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            let isValid = true;
            const selectedCategory = document.querySelector('input[name="category"]:checked');

            if (phoneInput.value.length !== 10) {
                phoneError.textContent = 'Please enter a valid 10-digit number';
                phoneError.classList.add('show'); isValid = false;
            } else if (hasParticipated(phoneInput.value)) {
                phoneError.textContent = 'This number has already played!';
                phoneError.classList.add('show'); isValid = false;
            }

            if (!selectedCategory) { categoryError.classList.add('show'); isValid = false; }

            if (isValid) {
                addParticipant(phoneInput.value, selectedCategory.value);
                window.currentParticipant = { phone: phoneInput.value, category: selectedCategory.value };
                
                document.getElementById('formContainer').style.display = 'none';
                document.getElementById('loading').style.display = 'block';

                // Determine Prize NOW
                const winningPrize = getWeightedRandomPrize();
                
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    // Show container FIRST so canvas has dimensions
                    document.getElementById('scratchContainer').style.display = 'flex';
                    // THEN setup the canvas
                    setupScratchCard(winningPrize);
                }, 1000);
            }
        });

        // --- NEW "DECK OF CARDS" LOGIC FOR TAP & WIN ---
        const POOL_KEY = 'maamis_prize_pool_v2';

        // 1. Create the deck
        function createPrizePool() {
            let pool = [];
            prizes.forEach((prize, index) => {
                for(let i = 0; i < prize.percentage; i++) {
                    pool.push(index);
                }
            });
            // Shuffle
            for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            return pool;
        }

        // 2. Get deck from storage
        function getPrizePool() {
            const stored = localStorage.getItem(POOL_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                if (parsed.length > 0) return parsed;
            }
            return createPrizePool();
        }

        // 3. THIS IS THE RENAMED FUNCTION FOR TAP.HTML
        function selectPrizeByPercentage() { 
            let pool = getPrizePool();
            
            // Take the last card
            const winningIndex = pool.pop(); 
            
            // Save updated deck
            localStorage.setItem(POOL_KEY, JSON.stringify(pool));
            
            return winningIndex;
        }

        // --- SCRATCH CARD LOGIC ---
        function setupScratchCard(prize) {
            const cardBack = document.getElementById('cardBack');
            
            // Set content behind scratch layer
            if (prize.isProduct && prize.image) {
                cardBack.innerHTML = `
                    <img src="${prize.image}" class="prize-image">
                    <div class="prize-text">${prize.name}</div>
                `;
            } else {
                cardBack.innerHTML = `
                    <div class="prize-emoji">üéÅ</div>
                    <div class="prize-text">${prize.name}</div>
                `;
            }

            // Initialize Canvas
            const canvas = document.getElementById('scratchCanvas');
            const wrapper = document.getElementById('scratchCardWrapper');
            const ctx = canvas.getContext('2d');
            
            // Ensure wrapper has size before setting canvas size
            const width = wrapper.offsetWidth;
            const height = wrapper.offsetHeight;

            canvas.width = width;
            canvas.height = height;

            // Draw Cover
            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, '#B0B0B0');
            gradient.addColorStop(1, '#E0E0E0');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            // Add Text to Cover
            ctx.fillStyle = '#666';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('SCRATCH HERE', width/2, height/2);

            // Scratching Logic
            let isDrawing = false;
            let scratched = false;

            function scratch(x, y) {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2);
                ctx.fill();
                checkCompletion();
            }

            function checkCompletion() {
                if (scratched) return;
                
                // Check percentage scratched
                const imageData = ctx.getImageData(0, 0, width, height);
                const pixels = imageData.data;
                let transparent = 0;
                for (let i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] === 0) transparent++;
                }
                const percent = (transparent / (pixels.length / 4)) * 100;

                if (percent > 40) {
                    scratched = true;
                    // Auto clear rest
                    canvas.style.opacity = '0';
                    canvas.style.transition = 'opacity 0.5s';
                    
                    // Send Data
                    if(window.currentParticipant) {
                        sendToGoogleSheets(window.currentParticipant.phone, window.currentParticipant.category, prize.name);
                    }

                    // Show Modal
                    setTimeout(() => showResult(prize), 800);
                }
            }

            // Mouse Events
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left,
                    y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top
                };
            };

            ['mousedown', 'touchstart'].forEach(evt => 
                canvas.addEventListener(evt, (e) => {
                    isDrawing = true;
                    const pos = getPos(e);
                    scratch(pos.x, pos.y);
                    document.querySelector('.scratch-icon').style.display = 'none';
                })
            );

            ['mousemove', 'touchmove'].forEach(evt => 
                canvas.addEventListener(evt, (e) => {
                    if (isDrawing) {
                        e.preventDefault();
                        const pos = getPos(e);
                        scratch(pos.x, pos.y);
                    }
                })
            );

            ['mouseup', 'touchend', 'mouseleave'].forEach(evt => 
                canvas.addEventListener(evt, () => isDrawing = false)
            );
        }

        const resultModal = document.getElementById('resultModal');
        const resultImage = document.getElementById('resultImage');
        const resultEmoji = document.getElementById('resultEmoji');
        const resultTitle = document.getElementById('resultTitle');
        const resultPrize = document.getElementById('resultPrize');
        const closeBtn = document.getElementById('closeBtn');

        function showResult(prize) {
            if (prize.isProduct && prize.image) {
                resultImage.src = prize.image;
                resultImage.style.display = 'block';
                resultEmoji.style.display = 'none';
            } else {
                resultImage.style.display = 'none';
                resultEmoji.style.display = 'block';
            }

            resultPrize.textContent = prize.name;
            resultModal.style.display = 'flex';
            createConfetti();
        }

       // NEW CODE (Goes back to 3 Games Home Page)
closeBtn.addEventListener('click', function() {
    // Redirect to the main dashboard
    window.location.href = 'index.html'; 
});

        function createConfetti() {
            const colors = ['#43e97b', '#38f9d7', '#FF6B6B', '#FFD93D'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }
    </script>
</body>
</html>